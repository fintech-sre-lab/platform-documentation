name: Deploy MkDocs to GitHub Pages

on:
    push:
        branches:
            - main
    workflow_dispatch:

permissions:
    contents: read

jobs:
    build-and-deploy:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout source repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.12"

            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install mkdocs mkdocs-material

            - name: Build MkDocs site
              run: mkdocs build --strict

            - name: Setup SSH deploy key
              uses: webfactory/ssh-agent@v0.9.0
              with:
                  ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

            - name: Deploy to GitHub Pages repository
              run: |
                  git config --global user.name "github-actions[bot]"
                  git config --global user.email "github-actions[bot]@users.noreply.github.com"

                  # Clone the target repository
                  git clone git@github.com:fintech-sre-lab/fintech-sre-lab.github.io.git deploy-repo

                  # Remove old content (except .git and CNAME if exists)
                  cd deploy-repo
                  find . -maxdepth 1 ! -name '.git' ! -name 'CNAME' ! -name '.' -exec rm -rf {} +

                  # Copy new content
                  cp -r ../site/* .

                  # Commit and push
                  git add -A
                  git diff --staged --quiet || git commit -m "Deploy MkDocs site - $(date +'%Y-%m-%d %H:%M:%S')"
                  git push origin main
